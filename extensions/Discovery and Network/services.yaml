kind: ConfigMap
apiVersion: v1
metadata:
  name: services
  namespace: baby-yoda
  labels:
    app.kubernetes.io/name: services
    busola.io/extension: resource
    busola.io/extension-version: '0.5'
data:
  details: |-
    header:
      - name: Controlled by
        source: metadata.ownerReferences
        widget: ControlledBy
      - name: Type
        source: spec.type
      - name: Cluster IP
        source: spec.clusterIP
      - name: Ports
        source: >-
          $count(spec.ports) ? $map(spec.ports, function($value) {$value.port =
          $value.targetPort ? [$string($value.port), '/', $string($value.protocol)]
          ~> $join('') : [$string($value.port), ':', $string($value.targetPort),
          '/', $string($value.protocol)] ~> $join('') }) ~> $join(', ')  : '-'
      - name: External IPs
        source: >-
          $count(status.loadBalancer.ingress) ? $map(status.loadBalancer.ingress,
          function($value) {$value.ip ? $value.ip : $value.hostname}) ~> $join(',
          '): ($count($item.spec.externalIPs) ? $item.spec.externalIPs ~> $join(',
          '): '-')
    body:
      - widget: ResourceList
        source: $subscriptions()
        name: Subscription
        children:
          - source: metadata.name
            name: Name
            sort: 'true'
            widget: ResourceLink
            resource:
              name: metadata.name
              namespace: $root.metadata.namespace
              kind: kind
          - source: spec.filter.filters[0].eventType.value
            name: First event type
            sort:
              default: true
              compareFunction: $compareStrings($first, $second)
          - source: status.ready
            name: Ready
            sort: true
            widget: Badge
            highlights:
              positive:
                - 'true'
              negative:
                - 'false'
      - widget: ResourceList
        source: $apirules()
        name: API Rule
        sort:
          - source: spec.service.host
            default: true
          - source: spec.service.port
            compareFunction: $first - $second
  form: |-
    - widget: KeyValuePair
      path: spec.selector
      simple: true
      name: Selectors
      placeholder: Enter Selectors
    - path: spec.type
      name: Type
      placeholder: Enter Type 
      trigger: [server]   
    - widget: GenericList
      path: spec.ports
      simple: true
      children:
        - path: '[]'
          simple: true
          children:
            - path: name
              simple: true
              name: Name
              placeholder: enter Ports Name
            - path: protocol
              simple: true
              name: Protocol
              placeholder: enter the Protocol
              widget: Text
              required: true
            - path: port
              simple: true
              name: Port
              placeholder: enter Port
              required: true
            - path: targetPort
              simple: true
              name: Target Port
              placeholder: enter Target Port
              widget: Text
              required: true
              inputInfo: Number or name of the port to access on the pods targeted by the service. Number must be in the range 1 to 65535.
            - path: nodePort
              simple: true
              name: Node Port
              placeholder: enter Node Port
            - path: appProtocol
              simple: true
              name: Application Protocol
              placeholder: enter Application Protocol
      template:
        protocol: 'TCP'
        port: 80
        targetPort: 9376 
    - widget: SimpleList
      path: spec.ipFamilies
      name: IP Family
      visibility: "$root.spec.type != 'ExternalName'"
      children:
        - path: '[]'
      placeholder: Enter IP Family
    - path: spec.ipFamilyPolicy
      name: IP Family Policy
      placeholder: Enter ip Family Policy
      enum: 
        - SingleStack
        - PreferDualStack
        - RequireDualStack
      visibility: "$root.spec.type != 'ExternalName'"

    - widget: SimpleList
      path: spec.clusterIPs
      name: cluster IPs
      children:
        - path: '[]'
      placeholder: Enter IP addresses assigned to this service
      visibility: "$root.spec.type != 'ExternalName'"
    - path: spec.clusterIP
      name: Cluster IP
      placeholder: Enter IP address of the service
      visibility: "$root.spec.type != 'ExternalName'"
    - widget: SimpleList
      path: spec.externalIPs
      name: external IPs
      children:
        - path: '[]'
      placeholder: Enter external IP addresses assigned to this service
    - path: spec.sessionAffinity
      name: session Affinity
      placeholder: Enter session Affinity
    - path: spec.externalTrafficPolicy
      name: external Traffic Policy
      placeholder: Enter external Traffic Policy
    - path: spec.internalTrafficPolicy
      name: internal Traffic Policy
      placeholder: Enter internal Traffic Policy  
    - widget: SimpleList
      path: spec.loadBalancerSourceRanges
      name: loadBalancer Source Ranges
      children:
        - path: '[]'
      placeholder: Enter loadBalancer Source Ranges   
    - path: spec.loadBalancerClass
      name: loadBalancer Class
      placeholder: Enter session Affinity  
      visibility: "$root.spec.type = 'LoadBalancer'"
    - path: spec.externalName
      name: loadBalancer Class
      placeholder: Enter loadBalancer Class
      visibility: "$root.spec.type = 'ExternalName'"
    - path: spec.loadBalancerIP
      name: loadBalancer IP
      placeholder: Enter session Affinity    
    - path: spec.healthCheckNodePort
      name: health Check Node Port
      placeholder: Enter health Check Node Port
      visibility: "$root.spec.type = 'LoadBalancer' and $root.spec.externalTrafficPolicy = 'Local'"
    - path: spec.allocateLoadBalancerNodePorts
      name: allocate LoadBalancer Node Ports
      visibility: "$root.spec.type = 'LoadBalancer'"
      subscribe:
        server: "$root.spec.type = 'LoadBalancer'"

  list: |-
    - name: Controlled By
      source: metadata.ownerReferences
      widget: ControlledBy
      kindOnly: true
    - name: Type
      source: spec.type
      sort:
        compareFunction: $compareStrings($second, $first)
    - name: Cluster IP
      source: spec.clusterIP
      sort: true
    - name: Ports
      source: >-
        $count(spec.ports) ? $map(spec.ports, function($value) {$value.port =
        $value.targetPort ? [$string($value.port), '/', $string($value.protocol)] ~>
        $join('') : [$string($value.port), ':', $string($value.targetPort), '/',
        $string($value.protocol)] ~> $join('') }) ~> $join(', ')  : '-'
    - name: External IPs
      source: >-
        $count(status.loadBalancer.ingress) ? $map(status.loadBalancer.ingress,
        function($value) {$value.ip ? $value.ip : $value.hostname}) ~> $join(', '):
        ($count($item.spec.externalIPs) ? $item.spec.externalIPs ~> $join(', '):
        '-')
  dataSources: |-
    apirules:
      resource:
        kind: APIRule
        group: gateway.kyma-project.io
        version: v1alpha1
      filter: $item.spec.service.name = $root.metadata.name
    subscriptions:
      resource:
        kind: Subscription
        group: eventing.kyma-project.io
        version: v1alpha1
      filter: >-
        $substringAfter($substringBefore($item.spec.sink, '.'), '://') =
        $root.metadata.name
  general: |-
    resource:
      kind: Service
      version: v1
    urlPath: services-ex
    scope: namespace
    name: Services
    category: Discovery and Network
  presets: |-
    - name: template
      default: true
      value:
        spec:
          selector: 
            app: ''
          type: 'ClusterIP'
          allocateLoadBalancerNodePorts: true
  translations: |-
    en:
      Cluster IP: Cluster IP
